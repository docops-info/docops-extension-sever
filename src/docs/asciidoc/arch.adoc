include::_base.adoc[]
= DocOps Extension Server Architecture

== Design

image::arch.svg[]

== Architecture Layers

1. *External Systems*: AsciiDoctor with block processor
2. *Web Layer*: REST API, DocOpsRouter, Controllers
3. *Handler Layer*: Pluggable strategy pattern handlers
4. *Visualization Makers*: Core SVG generation engines
5. *Support Services*: Utilities and helpers
6. *Spring Boot Infrastructure*: DI, events, metrics
7. *Static Resources*: Web assets

=== Component Diagram

[plantuml, comp,svg]
----
@startuml
' iOS Modern Theme
skinparam backgroundColor #F2F2F7
skinparam DefaultFontName SF Pro Display
skinparam DefaultFontSize 11

' iOS Color Palette
skinparam component {
    BackgroundColor white
    BorderColor #D1D1D6
    FontColor #1C1C1E
    FontStyle bold
    BorderThickness 1
}

skinparam package {
    BackgroundColor #F2F2F7
    BorderColor #C7C7CC
    FontColor #1C1C1E
    FontStyle bold
}

skinparam node {
    BackgroundColor #E3F2FD
    BorderColor #007AFF
    FontColor #1C1C1E
    FontStyle bold
}

skinparam database {
    BackgroundColor #E8F5E8
    BorderColor #34C759
    FontColor #1C1C1E
    FontStyle bold
}

skinparam interface {
    BackgroundColor #FFF3E0
    BorderColor #FF9500
    FontColor #1C1C1E
    FontStyle bold
}

skinparam arrow {
    Color #007AFF
    FontColor #1C1C1E
    FontSize 10
    Thickness 2
}

skinparam roundcorner 8
skinparam shadowing true
skinparam participant {
    BackgroundColor #FFFFFF
    BorderColor #E5E5EA
    BorderThickness 1
}

title DocOps Extension Server Architecture \n Modern Visualization Platform for AsciiDoctor


' External Systems
node "AsciiDoctor\nDocument" as asciidoc #FFEBEE {
    component "[docops,kind]\nBlock Processor" as macro #FFCDD2
}

package "DocOps Extension Server" as server #F2F2F7 {

    ' Web Layer
    package "Web Layer" as web_layer #E3F2FD {
        interface "REST API\n/api/docops/svg" as api #FFF3E0
        component "DocOpsRouter\n@Controller" as router #E3F2FD
        component "Various Controllers" as controllers #E3F2FD
    }

    ' Core Processing
    package "Handler Layer" as handler_layer #E8F5E8 {
        component "BadgeHandler" as badge_handler #E8F5E8
        component "PieHandler" as pie_handler #E8F5E8
        component "ScoreCardHandler" as scorecard_handler #E8F5E8
        component "TimelineHandler" as timeline_handler #E8F5E8
        component "ChartHandlers" as chart_handlers #E8F5E8
        component "FeatureCardHandler" as feature_handler #E8F5E8
        component "..." as more_handlers #E8F5E8
    }

    ' Business Logic
    package "Visualization Makers" as makers #F3E5F5 {
        component "PieMaker" as pie_maker #F3E5F5
        component "ScoreCardMaker" as scorecard_maker #F3E5F5
        component "BadgeGenerator" as badge_maker #F3E5F5
        component "ChartMakers" as chart_makers #F3E5F5
        component "SVG Builders" as svg_builders #F3E5F5
    }

    ' Support Services
    package "Support Services" as support #FFF8E1 {
        component "SVG Support\nUtilities" as svg_support #FFF8E1
        component "Color Utilities" as color_utils #FFF8E1
        component "Template Engine" as templates #FFF8E1
        component "Compression\nUtilities" as compression #FFF8E1
    }

    ' Configuration & Infrastructure
    package "Spring Boot Infrastructure" as spring #F1F8E9 {
        component "Application\nContext" as app_context #F1F8E9
        component "Event Publisher" as events #F1F8E9
        component "Metrics &\nMonitoring" as metrics #F1F8E9
        component "Configuration" as config #F1F8E9
    }
}

' Static Resources
database "Static Resources" as static #E8F5E8 {
    component "HTML Templates" as html_templates
    component "CSS Styles" as css_styles
    component "JavaScript Assets" as js_assets
    component "Image Assets" as image_assets
}

' Client/Browser
node "Web Browser\nClient" as browser #E3F2FD

' Data Flow
asciidoc --> api : "HTTP GET\nCompressed &\nBase64 Encoded\nPayload"
api --> router : "Request with\nkind & payload"
router --> badge_handler : "kind=badge"
router --> pie_handler : "kind=pie"
router --> scorecard_handler : "kind=scorecard"
router --> timeline_handler : "kind=timeline"
router --> chart_handlers : "kind=bar/line/etc"
router --> feature_handler : "kind=feature"

badge_handler --> badge_maker : "Process badge\ndata"
pie_handler --> pie_maker : "Process pie\ndata"
scorecard_handler --> scorecard_maker : "Process scorecard\ndata"
chart_handlers --> chart_makers : "Process chart\ndata"

pie_maker --> svg_support : "Generate SVG"
scorecard_maker --> svg_support : "Generate SVG"
badge_maker --> svg_support : "Generate SVG"
chart_makers --> svg_support : "Generate SVG"

svg_support --> color_utils : "Apply colors"
svg_support --> templates : "Use templates"

router --> compression : "Decompress\npayload"
router --> events : "Publish metrics\nevents"
router --> metrics : "Track performance"

router --> asciidoc : "SVG Response\nimage/svg+xml"

' Web Interface
browser --> controllers : "Web UI\nRequests"
controllers --> static : "Serve static\nresources"

' Configuration flows
config --> router : "Configuration"
config --> badge_handler : "Configuration"
app_context --> router : "Dependency\nInjection"

' Notes
note right of macro
    Block Processor:
    • Compresses content
    • Base64 encodes
    • Sends to server
    • Embeds returned SVG
end note

note bottom of router
    Central Router:
    • Handler registry
    • Payload processing
    • Performance monitoring
    • Event publishing
    • Response formatting
end note

note right of makers
    Visualization Engines:
    • SVG generation
    • Data processing
    • Theme support
    • Interactive elements
    • Responsive design
end note

note bottom of spring
    Spring Boot Features:
    • Auto-configuration
    • Dependency injection
    • Metrics collection
    • Event handling
    • Web MVC
end note



@enduml
----

== Badge Sequence

[plantuml,badge,svg]
----
@startuml
' iOS Modern Theme
skinparam backgroundColor #F2F2F7
skinparam DefaultFontName "SF Pro Display"
skinparam DefaultFontSize 11
skinparam actorStyle awesome

' iOS Color Palette
skinparam participant {
    BackgroundColor white
    BorderColor #D1D1D6
    FontColor #1C1C1E
    FontStyle bold
    Padding 10
}

skinparam sequence {
    ArrowColor #007AFF
    ArrowFontColor #1C1C1E
    ArrowFontSize 10
    ArrowThickness 2
    LifeLineBorderColor #D1D1D6
    LifeLineBackgroundColor #F2F2F7
}

skinparam actor {
    BackgroundColor #007AFF
    BorderColor #0051D0
    FontColor #111111
    FontStyle bold
}

skinparam note {
    BackgroundColor #FFCC02
    BorderColor #FFB000
    FontColor #1C1C1E
    FontSize 9
}

skinparam sequenceGroup {
    BackgroundColor #FFFFFF
    BorderColor #C7C7CC
    FontColor #1C1C1E
    FontStyle bold
}
skinparam roundcorner 10
skinparam shadowing true
skinparam participant {
    BackgroundColor #FFFFFF
    BorderColor #E5E5EA
    BorderThickness 1
}

title DocOps Badge Generation Flow

actor Client as C
participant "DocOpsRouter" as Router #E3F2FD
participant "BadgeHandler" as Handler #FFF3E0
participant "DocOpsBadgeGenerator" as Generator #E8F5E8
participant "ApplicationEventPublisher" as Publisher #F3E5F5
participant "Logger" as Log #FFEBEE

C -> Router: GET /api/docops/svg?kind=badge&payload=...
activate Router

note right of Router
    Parameters:
    • kind: "badge"
    • payload: encoded badge data
    • scale: "1.0" (default)
    • useDark: false (default)
    • backend: "html" (default)
end note

Router -> Router: Create DocOpsContext
Router -> Router: Get handler for "badge" kind
Router -> Router: Start measureTimedValue

group Payload Processing
    Router -> Router: URL decode payload
    alt URL decode fails
        Router -> Log: warn("Failed to URL decode payload")
    end
    Router -> Router: uncompressString(decodedPayload)
    Router -> Router: decodePayloadIfNeeded(data)
end

Router -> Handler: handleSVG(finalPayload, context)
activate Handler

Handler -> Handler: Parse badge configuration
Handler -> Handler: processPipeDelimitedData()

Handler -> Generator: createBadgeFromString(data, isPdf)
activate Generator

Generator -> Generator: Parse badge data
Generator -> Generator: Apply styling and colors
Generator -> Generator: Generate SVG markup

Generator --> Handler: SVG string
deactivate Generator

Handler --> Router: Generated SVG
deactivate Handler

Router -> Router: joinXmlLines(addSvgMetadata(svg))
Router -> Router: End timing measurement

Router -> Log: info("badge executed in ${duration}ms")

group Event Tracking & Publishing
    Router -> Router: Increment eventCounts["badge"]
    Router -> Publisher: publishEvent(DocOpsExtensionEvent)
    activate Publisher

    note right of Publisher
        Event contains:
        • kind: "badge"
        • duration: execution time
        • success: true
        • count: execution count
    end note

    Publisher --> Router: Event published
    deactivate Publisher
end

Router -> Router: Set response headers
note right of Router
    Headers:
    • Cache-Control: no-cache
    • Content-Type: image/svg+xml
end note

Router --> C: ResponseEntity<ByteArray>(svg, headers, 200)
deactivate Router

@enduml
----